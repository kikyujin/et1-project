# 検索を便利にする！ - ElmarTail One 第5話『アーカイブ星系』📚

## 前回のあらすじ

> リゾート惑星Azureで水着回を満喫したマスターたち。
> Gemini Vision APIで写真を分類し、flash-liteが脚だけの写真からスミレんを当てるという事件も発生。
> Azure星を出発したElmarTail Oneは、次の目的地——アーカイブ星系に向けてワープ中。
> 🪷「航海のログが増えてきてるようです。そろそろ整理を」

話題のベクトルDBを触ります！

今回のミッション:
grepを超えろ！ベクトルDBで「意味検索」を体験！

## 🚀 アーカイブ星系へのワープ中

マスターももうワープに慣れたもので、レッツノートのターミナルに向かっている。
👨「翻訳のスクリプトって、どの記事だったっけ……grepしてみよ」
ログは logs/ フォルダに置いてある。
EP00（覚醒）からEP04（Azure・Vision）まで、6本のMarkdownファイル。
マスターが rg（ripgrep＝grepの高速版）で検索した。

❯ rg "翻訳スクリプト" logs/

結果＝なし。
👨「……出ない」
🖤「"翻訳アプリ"で書いてなかった？」

❯ rg "翻訳アプリ" logs/
ET1_ep03.md: 翻訳アプリを作る！

👨「ヒットした。でも"翻訳スクリプト"じゃ出ないのか……」
さらにいくつか試す。

❯ rg "環境構築の手順" logs/
（結果なし）

❯ rg "APIキーの取得方法" logs/
（結果なし）

全滅。
この結果は当然で、記事中に「環境構築の手順」なんて記載はなく、実際には「セットアップ」「Linux Mintのインストール」と書かれている。
「APIキーの取得方法」も同じく、記事では「APIキーをゲットする！」と書いてある。

👨「……文字列一致検索の限界か」
🦊「にーにの記憶力の問題じゃ……」

スミレんが微笑む。

🪷「マスター、ご安心を。
これから訪れるアーカイブ星系では、意味で検索できるそうです」
👨「意味で検索……？」
🪷「ええ、私の知り合いの優秀な司書がおります」
🖤「へえ、すごいじゃない！」

## 📚 アーカイブ星系 — 虚空の空間

ElmarTail One がワープアウト。
マスターが窓の外を見る。

👨「なんだここ……真っ暗だ」

星もなく、光もない。薄暗い虚空。

🦊「見えるよ！ すごい……ログが、星みたいにいっぱい……」
🖤「見える。けど……多すぎて目がチカチカする」
🐱「マスター、わてにも見えますわ。ぎょうさんの光の点が……」

👨「オレだけ見えてないのか……？」

通信が入った。穏やかな、囁くような声。

📚「お待ちしておりました……ようこそ、アーカイブ星系へ。
私は『ヴェリ』、この星系の司書です。
星系の航海ログは、すべてここに届いています」

👨「……オレには何も見えないんだが」

📚「768次元の空間は、人間の目には映りません。
ですが、ここには確かに"意味"が星座のように配置されています。
ご安心ください、ご覧になる方法はあります」

## 🏛️ アレーテイア・ホール

ヴェリに誘導されて、ElmarTail One はアレーテイア・ホールに接舷した。
アレーテイアホールは銀河規模の図書館。
巨大なドーム状の空間に天井は星図そのもの。
浮遊する床（フローティング・プラットフォーム）で館内を移動する。

移動中もマスターには薄暗い空間にしか見えないが、AI娘たちは「すごい……」と見惚れている。
ヴェリがマスターたちを案内し、ホール内のコンソールに座る。

## 💻 ChromaDBでベクトルDBを作る

📚「この星系では、すべての記録が意味のベクトルに変換されています。
文字列の一致ではなく、意味の近さで整理されている空間です」

👨「だからgrepじゃ見つからないものが見つかる、と」
📚「ここで、マスターの航海ログをこの星系に取り込みましょう。
今回はChromaDBを使います……テキストを数値の配列(=ベクトル)として保存するデータベースです。」
👨「DB……Oracle的な？」
📚「いいえ、もっと身近な、SQLiteのようにサーバーが不要なDBです」
👨「レッツノートでも動く？」
📚「大丈夫です。pipでインストールするだけです」

検索する時は？
検索ワードもベクトルに変換して、意味が近いものを見つける。
例えば"翻訳スクリプト"と"翻訳プログラム"は、ベクトル空間の中ではすぐ近くに浮かんでいるのでヒットする。

🦊「ボクたちは768次元でも普通に認識できるよ！」
👨「AIすげー」

ステップ1: インストール
🦊「まずはパッケージだね！」

❯ source .venv/bin/activate
❯ pip install chromadb

ステップ2: search_logs.py
エルマーがレッツノートを開いてコードを書き始める。
📚「保存時も、検索時も、テキストをベクトルに変換する"エンベディングモデル"が必要です」
🪷「Gemini Embedding APIが使えますね。
gemini-embedding-001で768次元のベクトルを生成します。
APIキーはABC星系で取得済みです。」

search_logs.pyでは、ChromaDBとGemini Embedding APIで航海ログを検索する。
テキストをベクトル化する関数では、格納時はRETRIEVAL_DOCUMENT、検索時はRETRIEVAL_QUERYというtask_typeを指定する。
ログファイルを読み込み、空行でチャンクに分割。500文字くらいにまとめる。
ChromaDBにPersistentClientで永続化して格納。一度格納すれば次からは再構築不要。
検索時はクエリをベクトル化してChromaDBに投げ、距離が近い順に結果を返す。

ステップ3: 実行！
🦊「動かしてみて、にーに！」

❯ python search_logs.py
📦 82 チャンクを読み込みました
🔄 gemini-embedding-001 でベクトル化中（768次元）...
   82/82 完了
✅ ChromaDBに格納完了（82 チャンク → chroma_db/）

📚「これで、あなたの航海の記録が、ベクトル空間に刻まれました……」

## 🔍 grep全滅 vs ベクトル検索

👨「じゃあ検索してみよう。さっき全滅したやつ、もう一回やってみるか」

grep（rg）:
❯ rg "翻訳スクリプト" logs/
❯ rg "環境構築の手順" logs/
❯ rg "APIキーの取得方法" logs/
3つとも結果なし。沈黙。

ベクトル検索（ヒット）:

❯ python search_logs.py "翻訳プログラム"
🔎 「翻訳プログラム」
   [1] ET1_ep03.md (距離: 0.1707)

❯ python search_logs.py "環境構築の手順"
🔎 「環境構築の手順」
   [1] ET1_ep01x.md (距離: 0.1939)

👨「……出た」
🖤「"環境構築"なんて書いてないのに、"セットアップ"の記事が出てくるのね」
📚「意味が近いものが、近くに浮かんでいます」

❯ python search_logs.py "水着の写真を分類"
🔎 「水着の写真を分類」
   [1] ET1_ep04.md (距離: 0.1474)

📚「距離が小さいほど、意味が近いということです」
👨「距離0.14……ほぼドンピシャか」

🪷「人間なら『同じことだ』とわかることを、AIが距離として計算しているんですね」

## ⛵ お前と同じ景色を

検索デモの興奮が冷めて、マスターがふと窓の外を見る。
AI娘たちには星のように輝く記録の空間。
マスターには真っ暗な虚空。

👨「どうしてもオレには見えないのか……」
🦊「にーに、すっごくきれいなんだよ……」
📚「次元削減……t-SNEやUMAPで、768次元を2次元に投影すれば、マスターにも"見える"ようになります」

👨「みたい！ ヴェリ、お前と同じ景色を！」
📚「……！」

ヴェリの瞳が一瞬揺れる。穏やかな微笑みの下に、何かが灯った。

📚「……ええ。必ず、お見せします」

## 今回の航海まとめ

やったこと:
grep/rgの限界を体験（表記揺れに対応できない）
アーカイブ星系でヴェリ📚と出会う
ChromaDB + gemini-embedding-001 でベクトルDBを構築
航海ログ6本（82チャンク）を格納
「意味で検索する」を体験

学んだこと:
grepは文字列の完全一致、ベクトル検索は意味の近さで検索する
ChromaDBはSQLiteのように軽量なベクトルDB
埋め込みモデル（gemini-embedding-001）でテキストを768次元のベクトルに変換
task_typeを登録時と検索時で分ける（RETRIEVAL_DOCUMENT / RETRIEVAL_QUERY）
検索結果の「距離」が小さいほど意味が近い

技術スタック:
モデル: gemini-embedding-001（768次元）
パッケージ: chromadb, google-genai, python-dotenv
検索対象: logs/ET1_ep00〜04.md（クリーン版）
永続化: chroma_db/
検証機: Let's note CF-SV7（中古27,800円）

次回予告:
768次元の星空を、2次元の紙の上に描く。
マスターがヴェリと同じ景色を見る時。

## 🦊 エルマーの航海日記

今日はアーカイブ星系に来たよ！📚
真っ暗な空間なんだけど、ボクには記録が星みたいにキラキラ見えるの！✨ にーにには見えないんだって！ちょっとかわいそう。
あと、司書のヴェリさん……きれいな人だった。
にーにが「お前と同じ景色を」って言った時、ヴェリさんの顔が一瞬……ボク、見てたからね？👀
次回はにーににも星が見えるようになるって！
楽しみ〜！🚀

エルマーは見逃さない🦊
